{
    "provider": {
        "google": {
            "project": "${var.project}",
            "region": "${var.region_name}",
            "credentials": "${file(\"${var.credentials}\")}"
        }
    },
    "locals": {
        "common_labels": {
            "owner": "${var.owner}",
            "skip_deletion": "${var.skip_deletion}"
        }
    },
    "module": {
        "network-vpc": {
            "source": "../../../../modules/gcp/network",
            "name": "${var.deployment_name}-${var.env}",
            "region": "${var.region_name}",
            "resource_tags": "${local.common_labels}",
            "subnets": "${local.computed_subnets}",
            "bastion_subnet": "${local.computed_bastion_subnet}",
            "private_conf": "${var.private_conf}",
            "client_enabled": "${var.client_enabled}"
        },
        "rs-cluster": {
            "source": "../../../../modules/gcp/re",
            "name": "${var.deployment_name}-${var.env}",
            "worker_count": "${var.cluster_size}",
            "machine_type": "${var.machine_type}",
            "machine_image": "${var.machine_image}",
            "resource_tags": "${local.common_labels}",
            "ssh_user": "${var.ssh_user}",
            "ssh_public_key": "${var.ssh_public_key}",
            "availability_zones": "${local.selected_zones}",
            "rack_aware": "${var.rack_aware}",
            "subnets": "${module.network-vpc.subnets}",
            "private_conf": "${var.private_conf}",
            "cluster_dns": "cluster.${var.env}-${var.deployment_name}.${var.hosted_zone}",
            "redis_distro": "${var.rs_release}",
            "boot_disk_size": "${var.volume_size}",
            "redis_user": "${var.rs_user}",
            "redis_password": "${var.rs_password}",
            "ssh_private_key": "${var.ssh_private_key}",
            "flash_enabled": "${var.flash_enabled}"
        },
        "rs-client": {
            "source": "../../../../modules/gcp/bastion",
            "name": "${var.deployment_name}-${var.env}",
            "subnet": "${module.network-vpc.bastion-subnet[0].id}",
            "availability_zone": "${local.bastion_zone}",
            "machine_image": "${var.machine_image}",
            "machine_type": "${var.bastion_machine_type}",
            "memtier_package": "${var.memtier_package}",
            "prometheus_package": "${var.prometheus_package}",
            "grafana_version": "${var.grafana_version}",
            "java_version": "${var.java_version}",
            "cluster_dns": "${module.rs-cluster-dns.cluster_dns}",
            "boot_disk_size": "${var.volume_size}",
            "resource_tags": "${local.common_labels}",
            "ssh_user": "${var.ssh_user}",
            "ssh_public_key": "${var.ssh_public_key}"
        },
        "rs-cluster-dns": {
            "source": "../../../../modules/gcp/ns-public",
            "subdomain": "${var.env}-${var.deployment_name}",
            "hosted_zone_name": "${var.hosted_zone_name}",
            "hosted_zone": "${var.hosted_zone}",
            "resource_tags": "${local.common_labels}",
            "ip_addresses": "${module.rs-cluster.re-public-ips}"
        }
    },
    "output": {
        "rs-client-public-IP": {
            "value": "${module.rs-client.public-ip}"
        },
        "rs-client-ssh-command": {
            "value": "${module.rs-client.ssh-command}"
        },
        "rs-prometheus-endpoint": {
            "value": "${module.rs-client.prometheus-endpoint}"
        },
        "rs-grafana-endpoint": {
            "value": "${module.rs-client.grafana-endpoint}"
        },
        "rs-insight-endpoint": {
            "value": "${module.rs-client.redisinsight-endpoint}"
        },
        "rs-cluster-public-ips": {
            "value": "${module.rs-cluster.re-public-ips}"
        },
        "rs-cluster-private-ips": {
            "value": "${module.rs-cluster.re-private-ips}"
        },
        "rs-cluster-nodes-dns": {
            "value": "${module.rs-cluster-dns.A-records}"
        },
        "rs-cluster-ui-dns": {
            "value": [
                "https://${module.rs-cluster-dns.cluster_master_dns}:8443",
                "https://${module.rs-cluster-dns.cluster_dns}:8443"
            ]
        },
        "ssh-connection-commands": {
            "description": "SSH commands to connect to the cluster nodes",
            "value": "${[for idx, ip in module.rs-cluster.re-public-ips : \"ssh -i ${replace(var.ssh_public_key, \".pub\", \"\")} ${var.ssh_user}@${ip}  # Node ${idx + 1}\"]}"
        },
        "ssh-bastion-command": {
            "description": "SSH command to connect to the bastion/client node",
            "value": "ssh -i ${replace(var.ssh_public_key, \".pub\", \"\")} ${var.ssh_user}@${module.rs-client.public-ip}"
        },
        "dns-flush-commands": {
            "description": "Commands to flush DNS cache if cluster DNS is not resolving",
            "value": [
                "# macOS:      sudo sh -c 'dscacheutil -flushcache; killall -HUP mDNSResponder'",
                "# Linux:      sudo systemd-resolve --flush-caches  # or: sudo systemctl restart nscd",
                "# Windows:    ipconfig /flushdns"
            ]
        }
    }
}